<!DOCTYPE html>
<html>

<head>
    <title>Your Goals</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles/dashboard.css') }}">
</head>

<body>
    <div class="container">

        <div class="header">
            <h1>Your Goals</h1>
            <button class="theme-toggle" onclick="toggleTheme()">Toggle Theme</button>
        </div>

        <div id="goals"></div>

        <h2 class="section-title">Create a Goal</h2>

        <div class="card">
            <label>Title:</label><br>
            <input id="title" type="text"><br><br>

            <label>Description:</label><br>
            <textarea id="description" rows="3"></textarea><br><br>

            <button id="createBtn" class="btn btn-accent">Create</button>
        </div>

        <button class="btn btn-outline" onclick="window.location.href='/main'">Back to Main</button>
        <button class="btn btn-accent" onclick="logout()">Logout</button>

    </div>

    <div id="modal_container" class="modal-overlay">
        <div class="modal-card">
            <h2>Edit Goal</h2>

            <label>Title:</label><br>
            <input id="editTitle" type="text"><br><br>

            <label>Description:</label><br>
            <textarea id="editDescription" rows="3"></textarea><br><br>

            <button class="btn btn-outline" onclick="closeEditModal()">Cancel</button>
            <button class="btn btn-accent" onclick="saveGoal()">Save</button>

        </div>
    </div>


    <script>
        const token = localStorage.getItem("access_token");

        if (!token) {
            alert("You must be logged in.");
            window.location.href = "/";
        }

        function applySavedTheme() {
            const saved = localStorage.getItem("theme");
            if (saved === "dark") document.body.classList.add("dark-mode");
        }

        function toggleTheme() {
            document.body.classList.toggle("dark-mode");
            localStorage.setItem("theme",
                document.body.classList.contains("dark-mode") ? "dark" : "light");
        }

        applySavedTheme();

        /* Load Goals */
        async function loadGoals() {
            const res = await fetch("/goals/", {
                headers: { "Authorization": "Bearer " + token }
            });

            const goals = await res.json();
            const container = document.getElementById("goals");
            container.innerHTML = "";

            if (!goals.length) {
                container.innerHTML = "<p>No goals created yet.</p>";
                return;
            }

            goals.forEach(goal => {
                container.innerHTML += `
            <div class="goal-card">
                <h3>${goal.title}</h3>
                <p>${goal.description}</p>
                <button class="btn btn-outline" onclick="deleteGoal(${goal.id})">Delete</button>
                <button class="btn btn-outline" onclick="editGoal(${goal.id}, '${goal.title}', '${goal.description}')">Edit</button>
            </div>`;
            });
        }

        /* Create Goal */
        document.getElementById("createBtn").addEventListener("click", async () => {
            const title = document.getElementById("title").value.trim();
            const description = document.getElementById("description").value.trim();
            const token = localStorage.getItem("access_token");

            console.log("Submitting goal:", title, description);

            if (!title) {
                alert("Title required.");
                return;
            }

            try {
                const res = await fetch("/goals/", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "Authorization": "Bearer " + token
                    },
                    body: JSON.stringify({ title, description })
                });

                console.log("Response status:", res.status);

                const data = await res.json().catch(() => ({}));

                if (res.ok) {
                    alert("Goal created!");
                    loadGoals();
                } else {
                    console.log("Server error:", data);
                    alert(data.error || "Error creating goal.");
                }
            } catch (err) {
                console.error("JS fetch error:", err);
                alert("Network error.");
            }
        });

        /* Delete Goal */
        async function deleteGoal(id) {
            const res = await fetch("/goals/" + id, {
                method: "DELETE",
                headers: { "Authorization": "Bearer " + token }
            });

            if (res.ok) {
                alert("Goal deleted!");
                loadGoals();
            } else {
                alert("Delete failed.");
            }
        }

        let currentEditId = null;

        /* Open the Edit Goal Modal */
        function editGoal(id, title, description) {
            currentEditId = id;
            document.getElementById("editTitle").value = title;
            document.getElementById("editDescription").value = description;

            document.getElementById("modal_container").style.display = "flex";
        }

        /* Close the Edit Goal Modal */
        function closeEditModal(id, title, description) {
            document.getElementById("modal_container").style.display = "none";
        }

        /* Edit Goal */
        async function saveGoal() {
            const title = document.getElementById("editTitle").value.trim();
            const description = document.getElementById("editDescription").value.trim();

            const res = await fetch("/goals/" + currentEditId, {
                method: "PUT",
                headers: {
                    "Content-Type": "application/json",
                    "Authorization": "Bearer " + token
                },
                body: JSON.stringify({ title, description })
            });

            const data = await res.json();

            if (res.ok) {
                alert("Goal updated!");
                closeEditModal();
                loadGoals();
            } else {
                alert(data.error || "Error editing goal.");
            }
        }

        /* Logout */
        function logout() {
            localStorage.removeItem("access_token");
            window.location.href = "/";
        }

        loadGoals();
    </script>

</body>

</html>